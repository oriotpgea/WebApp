<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orienteering Web Challenge</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, onSnapshot, collection, query, where, getDocs, orderBy, updateDoc, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB2k1aw2nNA7O5Lw4DhQiNKy_o6VpZ3v4k",
            authDomain: "webapp-e67fe.firebaseapp.com",
            projectId: "webapp-e67fe",
            storageBucket: "webapp-e67fe.firebasestorage.app",
            appId: "1:137078762697:web:654b6e931dbc85ef2c7118"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        
        const views = ['loadingView', 'loginView', 'organizerHomeView', 'joinEventView', 'participantLobbyView', 'participantView', 'checkpointView', 'organizerDashboardView', 'organizerDetailView', 'organizerAdminView', 'organizerTeamsView', 'galleryView'];
        function showView(viewId) {
            views.forEach(id => {
                const el = document.getElementById(id);
                if(el) el.classList.add('hidden');
            });
            const viewToShow = document.getElementById(viewId);
            if(viewToShow) viewToShow.classList.remove('hidden');
            window.scrollTo(0, 0);
        }

        let currentEventId = null;
        let currentUserRole = null;
        let currentUserId = null;
        let participantListenerUnsub = null; 

        onAuthStateChanged(auth, async user => {
            if (participantListenerUnsub) { participantListenerUnsub(); participantListenerUnsub = null; }
            
            if (user) {
                currentUserId = user.uid;
                try {
                    const userDoc = await getDoc(doc(db, "users", user.uid));
                    if (userDoc.exists() && userDoc.data().role === 'organizer') {
                        currentUserRole = 'organizer';
                        initOrganizerHomeView(user);
                    } else {
                        currentUserRole = 'participant';
                        const savedEventId = localStorage.getItem('currentEventId-' + user.uid);
                        if (savedEventId) {
                            const eventDoc = await getDoc(doc(db, "events", savedEventId));
                            if (eventDoc.exists()) {
                                currentEventId = savedEventId;
                                const eventStatus = eventDoc.data().status;
                                if (eventStatus === 'active') {
                                    initParticipantView(currentUserId);
                                } else if (eventStatus === 'pending') {
                                    initParticipantLobbyView();
                                } else { // 'finished'
                                    initParticipantView(currentUserId, true);
                                }
                            } else {
                                localStorage.removeItem('currentEventId-' + user.uid);
                                showView('joinEventView');
                            }
                        } else {
                            showView('joinEventView');
                        }
                    }
                } catch (error) {
                    showModal("Errore Critico", "Impossibile verificare il tuo ruolo utente. " + error.message, false, () => signOut(auth));
                }
            } else {
                currentUserId = null; currentUserRole = null; currentEventId = null;
                showView('loginView');
            }
        });
        
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalConfirmBtn = document.getElementById('modalConfirmBtn');
        const modalCancelBtn = document.getElementById('modalCancelBtn');
        let confirmCallback = null;
        function showModal(title, message, showConfirm = false, onConfirm = null) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            confirmCallback = onConfirm;
            modalConfirmBtn.classList.toggle('hidden', !showConfirm);
            modalCancelBtn.textContent = showConfirm ? 'Annulla' : 'Chiudi';
            modal.classList.remove('hidden');
        }
        modalCancelBtn.addEventListener('click', () => modal.classList.add('hidden'));
        modalConfirmBtn.addEventListener('click', () => { if (confirmCallback) confirmCallback(); modal.classList.add('hidden'); });
        document.getElementById('loginForm').addEventListener('submit', (e) => { e.preventDefault(); signInWithEmailAndPassword(auth, loginForm.email.value, loginForm.password.value).catch(err => showModal("Errore", "Login fallito: " + err.message)); });
        document.getElementById('registerForm').addEventListener('submit', async (e) => { e.preventDefault(); try { const cred = await createUserWithEmailAndPassword(auth, registerForm.email.value, registerForm.password.value); await setDoc(doc(db, "users", cred.user.uid), { role: 'participant' }); } catch (error) { showModal("Errore", "Registrazione fallita: " + error.message); } });

        function initOrganizerHomeView(user) {
            const eventsList = document.getElementById('organizerEventsList');
            const q = query(collection(db, "events"), where("organizerId", "==", user.uid), orderBy("creation_time", "desc"));
            onSnapshot(q, (snapshot) => {
                eventsList.innerHTML = snapshot.empty ? `<p class="text-gray-500">Nessun evento creato.</p>` : '';
                snapshot.forEach(doc => {
                    const event = doc.data();
                    const eventCard = document.createElement('div');
                    eventCard.className = 'p-4 bg-white rounded-lg shadow-md flex justify-between items-center';
                    eventCard.innerHTML = `<div><h3 class="font-bold text-lg">${event.name}</h3><p class="text-sm text-indigo-600 font-semibold">Codice: ${event.joinCode}</p><p class="text-xs text-gray-500 mt-1">Stato: <span class="font-medium ${event.status === 'active' ? 'text-green-500' : event.status === 'finished' ? 'text-gray-500' : 'text-yellow-500'}">${event.status}</span></p></div><div class="flex items-center space-x-2"><button class="manage-event-btn bg-blue-500 text-white px-3 py-2 rounded-md hover:bg-blue-600 text-sm font-semibold">Gestisci</button><button class="delete-event-btn bg-red-600 text-white p-2 rounded-full hover:bg-red-700"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div>`;
                    eventCard.querySelector('.manage-event-btn').onclick = () => { currentEventId = doc.id; initOrganizerDashboardView(); };
                    eventCard.querySelector('.delete-event-btn').onclick = () => deleteEvent(doc.id, event.name);
                    eventsList.appendChild(eventCard);
                });
                lucide.createIcons();
            });
            showView('organizerHomeView');
        }

        async function deleteEvent(eventId, eventName) {
            showModal("Conferma Eliminazione", `Sei sicuro di voler eliminare l'evento "${eventName}"? TUTTI i dati verranno cancellati per sempre.`, true, async () => {
                try {
                    const batch = writeBatch(db);
                    const [checkpointsSnapshot, teamsSnapshot, submissionsSnapshot] = await Promise.all([ getDocs(collection(db, `events/${eventId}/checkpoints`)), getDocs(collection(db, `events/${eventId}/teams`)), getDocs(query(collection(db, "submissions"), where("eventId", "==", eventId))) ]);
                    checkpointsSnapshot.forEach(doc => batch.delete(doc.ref));
                    teamsSnapshot.forEach(doc => batch.delete(doc.ref));
                    submissionsSnapshot.forEach(doc => batch.delete(doc.ref));
                    batch.delete(doc(db, "events", eventId));
                    await batch.commit();
                    showModal("Successo", `Evento "${eventName}" eliminato.`);
                } catch (error) { showModal("Errore", "Eliminazione fallita: " + error.message); }
            });
        }

        document.getElementById('createEventForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const eventName = document.getElementById('eventName').value;
            const joinCode = `GARA-${Math.random().toString(36).substr(2, 4).toUpperCase()}`;
            await addDoc(collection(db, "events"), { name: eventName, joinCode: joinCode, organizerId: currentUserId, status: 'pending', creation_time: new Date() });
            e.target.reset();
        });
        
        document.getElementById('logout-organizer-home').addEventListener('click', () => signOut(auth));
        
        async function initOrganizerDashboardView() { showView('organizerDashboardView'); setupDashboardListener(); }
        let unsubscribeDashboard;
        async function setupDashboardListener() {
            if(unsubscribeDashboard) unsubscribeDashboard();
            const eventRef = doc(db, "events", currentEventId);
            unsubscribeDashboard = onSnapshot(eventRef, async () => { 
                try {
                    const [eventDoc, teamsSnapshot, checkpointsSnapshot, submissionsSnapshot] = await Promise.all([
                        getDoc(eventRef),
                        getDocs(collection(db, `events/${currentEventId}/teams`)),
                        getDocs(query(collection(db, `events/${currentEventId}/checkpoints`), orderBy("number"))),
                        getDocs(query(collection(db, "submissions"), where("eventId", "==", currentEventId)))
                    ]);
                    const eventData = eventDoc.data();
                    renderOrganizerUI(
                        eventData,
                        teamsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })),
                        checkpointsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })),
                        submissionsSnapshot.docs.map(doc => ({id: doc.id, ...doc.data()}))
                    );
                } catch (error) { showModal("Errore Dashboard", "Impossibile caricare i dati: " + error.message); }
            });
        }

        function renderOrganizerUI(eventData, teams, checkpoints, submissions) {
            const organizerGrid = document.getElementById('organizerGrid');
            let tableHtml = `<thead class="bg-gray-200"><tr><th class="p-3 text-left">Squadra</th>${checkpoints.map(c => `<th class="p-3 text-center w-20">${c.number}</th>`).join('')}</tr></thead><tbody>`;
            teams.forEach(team => { tableHtml += `<tr class="border-b"><td class="p-3 font-medium">${team.name}</td>${checkpoints.map(c => `<td id="cell-${team.id}-${c.id}" class="p-3 text-center align-middle"><i data-lucide="circle-dashed" class="w-5 h-5 text-gray-400 mx-auto"></i></td>`).join('')}</tr>`; });
            organizerGrid.innerHTML = tableHtml + '</tbody>';
            const teamScores = {};
            teams.forEach(team => { teamScores[team.id] = { name: team.name, score: 0, completed: 0 }; });
            
            submissions.forEach(sub => {
                if (!sub.teamId || !teamScores[sub.teamId]) return;
                const checkpoint = checkpoints.find(c => c.id === sub.checkpointId);

                teamScores[sub.teamId].completed++;
                if (!checkpoint || typeof checkpoint.correctAnswer === 'undefined') return;

                const isCorrect = checkpoint.correctAnswer.toLowerCase().trim() === sub.answer.toLowerCase().trim();
                if (isCorrect) { 
                    teamScores[sub.teamId].score += (checkpoint.points || 0); 
                    const eventStartTime = eventData.startTime?.toDate();
                    if(eventStartTime && checkpoint.timeBonus > 0) {
                        const submissionTime = sub.timestamp.toDate();
                        const timeDiffMinutes = (submissionTime - eventStartTime) / 60000;
                        if(timeDiffMinutes <= checkpoint.timeBonus) {
                            teamScores[sub.teamId].score += (checkpoint.bonusPoints || 0);
                        }
                    }
                }
                const cell = document.getElementById(`cell-${sub.teamId}-${sub.checkpointId}`);
                if (cell) {
                    cell.innerHTML = `<div class="flex flex-col items-center cursor-pointer" title="Clicca per i dettagli">
                        ${isCorrect ? '<i data-lucide="check-circle-2" class="w-6 h-6 text-green-600 mx-auto"></i>' : '<i data-lucide="x-circle" class="w-6 h-6 text-red-500 mx-auto"></i>'}
                        <i data-lucide="camera" class="w-4 h-4 text-gray-400 hover:text-blue-500 mt-1"></i>
                    </div>`;
                    cell.querySelector('div').addEventListener('click', () => showSubmissionDetail(sub, checkpoint, isCorrect, teams.find(t => t.id === sub.teamId)));
                }
            });
            const leaderboardBody = document.getElementById('leaderboardBody');
            const sortedTeams = Object.values(teamScores).sort((a, b) => b.score - a.score);
            leaderboardBody.innerHTML = sortedTeams.map((team, index) => `<tr class="border-b ${index === 0 ? 'bg-yellow-100' : ''}"><td class="p-2 text-center font-bold">${index + 1}</td><td class="p-2">${team.name}</td><td class="p-2 text-center">${team.completed}/${checkpoints.length}</td><td class="p-2 text-right font-bold">${team.score}</td></tr>`).join('');
            
            const galleryBtn = document.getElementById('galleryBtn');
            galleryBtn.disabled = eventData.status !== 'finished';
            galleryBtn.title = eventData.status !== 'finished' ? "Disponibile al termine della gara" : "Vedi galleria foto";
            galleryBtn.classList.toggle('opacity-50', eventData.status !== 'finished');
            galleryBtn.classList.toggle('cursor-not-allowed', eventData.status !== 'finished');
            
            lucide.createIcons();
        }
        
        document.getElementById('exportCsvBtn').addEventListener('click', () => { /* ... unchanged ... */ });
        document.getElementById('backToOrganizerHome').addEventListener('click', () => { if(unsubscribeDashboard) unsubscribeDashboard(); currentEventId = null; showView('organizerHomeView'); });
        
        document.getElementById('startEventBtn').addEventListener('click', () => {
            showModal("Conferma Avvio", "Sei sicuro di voler avviare la gara? Verrà registrato l'orario di inizio per i bonus a tempo.", true, async () => {
                if(!currentEventId) return;
                await updateDoc(doc(db, "events", currentEventId), { status: 'active', startTime: new Date() });
                showModal("Successo", "Evento avviato!");
            });
        });
        document.getElementById('finishEventBtn').addEventListener('click', () => {
            showModal("Conferma Termine", "Sei sicuro di voler terminare la gara?", true, async () => {
                if(!currentEventId) return;
                await updateDoc(doc(db, "events", currentEventId), { status: 'finished' });
                showModal("Successo", "Evento terminato!");
            });
        });

        document.getElementById('galleryBtn').addEventListener('click', async () => {
            const galleryGrid = document.getElementById('galleryGrid');
            galleryGrid.innerHTML = '<i data-lucide="loader-2" class="w-16 h-16 animate-spin text-indigo-600 mx-auto col-span-full"></i>';
            lucide.createIcons();
            showView('galleryView');
            try {
                const teamsQuery = collection(db, `events/${currentEventId}/teams`);
                const checkpointsQuery = query(collection(db, `events/${currentEventId}/checkpoints`));
                const submissionsQuery = query(collection(db, "submissions"), where("eventId", "==", currentEventId), orderBy("timestamp", "desc"));

                const [teamsSnapshot, checkpointsSnapshot, submissionsSnapshot] = await Promise.all([getDocs(teamsQuery), getDocs(checkpointsQuery), getDocs(submissionsQuery)]);

                const teamsMap = new Map();
                teamsSnapshot.forEach(doc => teamsMap.set(doc.id, doc.data().name));
                const checkpointsMap = new Map();
                checkpointsSnapshot.forEach(doc => checkpointsMap.set(doc.id, doc.data().number));

                galleryGrid.innerHTML = '';
                if (submissionsSnapshot.empty) {
                    galleryGrid.innerHTML = '<p class="col-span-full text-center">Nessuna foto inviata durante questo evento.</p>';
                    return;
                }
                submissionsSnapshot.forEach(doc => {
                    const sub = doc.data();
                    const checkpointNumber = checkpointsMap.get(sub.checkpointId) || '?';
                    const teamName = teamsMap.get(sub.teamId) || 'Squadra Sconosciuta';
                    const imgCard = document.createElement('div');
                    imgCard.className = 'bg-white p-2 rounded-lg shadow-md';
                    imgCard.innerHTML = `<img src="${sub.photoUrl}" class="w-full h-48 object-cover rounded-md" alt="Foto di squadra"><div class="mt-1 text-xs"><p class="font-semibold text-gray-800">${teamName}</p><p class="text-gray-500">Punto #${checkpointNumber}</p></div>`;
                    galleryGrid.appendChild(imgCard);
                });
            } catch (error) {
                galleryGrid.innerHTML = '';
                showModal("Errore Galleria", "Impossibile caricare le foto. Potrebbe mancare un indice nel database. Controlla la console per sviluppatori (CTRL+SHIFT+I) per un link per crearlo. Dettagli: " + error.message);
            }
        });
        document.getElementById('backToDashboardFromGallery').addEventListener('click', () => showView('organizerDashboardView'));

        document.getElementById('joinEventForm').addEventListener('submit', async (e) => { 
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            btn.disabled = true;
            try {
                const joinCode = document.getElementById('joinCode').value.toUpperCase();
                const teamName = document.getElementById('teamName').value;
                const q = query(collection(db, "events"), where("joinCode", "==", joinCode));
                const eventSnapshot = await getDocs(q);
                if(eventSnapshot.empty) { throw new Error("Codice evento non valido."); }
                
                currentEventId = eventSnapshot.docs[0].id;
                const eventData = eventSnapshot.docs[0].data();

                if (eventData.status === 'finished') { throw new Error("Questo evento è già concluso."); }
                
                await setDoc(doc(db, `events/${currentEventId}/teams`, currentUserId), { name: teamName }, { merge: true });
                
                localStorage.setItem('currentEventId-' + currentUserId, currentEventId);
                initParticipantLobbyView();

            } catch (error) {
                showModal("Errore", error.message);
                btn.disabled = false;
            }
         });
        function initParticipantLobbyView() { 
            if (participantListenerUnsub) participantListenerUnsub();
            const eventDocRef = doc(db, "events", currentEventId);
            participantListenerUnsub = onSnapshot(eventDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const eventData = docSnap.data();
                    document.getElementById('lobbyEventName').textContent = eventData.name;
                    if (eventData.status === 'active') { 
                        if (participantListenerUnsub) { participantListenerUnsub(); participantListenerUnsub = null; }
                        initParticipantView(currentUserId); 
                    } 
                    else if (eventData.status === 'pending') { 
                        showView('participantLobbyView'); 
                    } 
                    else { 
                        if (participantListenerUnsub) { participantListenerUnsub(); participantListenerUnsub = null; }
                        initParticipantView(currentUserId, true); 
                    }
                } else {
                    if (participantListenerUnsub) { participantListenerUnsub(); participantListenerUnsub = null; }
                    showModal("Errore", "L'evento a cui eri iscritto è stato cancellato.", false, () => signOut(auth));
                }
            }, (error) => { console.error("Lobby listener error:", error); });
         }
        document.getElementById('logout-join').addEventListener('click', () => signOut(auth));
        document.getElementById('logout-lobby').addEventListener('click', () => signOut(auth));
        document.getElementById('logout-participant').addEventListener('click', async () => {
            const eventDoc = await getDoc(doc(db, "events", currentEventId));
            if(eventDoc.exists() && eventDoc.data().status === 'finished') {
                showModal("Sei sicuro di voler uscire?", "Uscendo ora non potrai più rientrare per vedere le tue risposte. L'evento è concluso.", true, () => {
                    localStorage.removeItem('currentEventId-' + currentUserId);
                    signOut(auth);
                });
            } else {
                localStorage.removeItem('currentEventId-' + currentUserId);
                signOut(auth);
            }
        });
        async function initParticipantView(teamId, isReadOnly = false) { 
            if (participantListenerUnsub) participantListenerUnsub();
            
            const eventDocRef = doc(db, "events", currentEventId);
            participantListenerUnsub = onSnapshot(eventDocRef, (docSnap) => {
                if (docSnap.exists() && docSnap.data().status === 'finished' && !isReadOnly) {
                    showModal("Gara Terminata!", "L'organizzatore ha concluso la gara. Puoi ancora vedere le tue risposte, ma non puoi più inviarne di nuove.", false);
                    initParticipantView(teamId, true); 
                }
            });

            try {
                document.getElementById('game-finished-banner').classList.toggle('hidden', !isReadOnly);
                const teamDoc = await getDoc(doc(db, `events/${currentEventId}/teams`, teamId));
                if(teamDoc.exists()) { document.getElementById('participant-team-name-display').textContent = `Squadra: ${teamDoc.data().name}`; }
                const checkpointsQuery = query(collection(db, `events/${currentEventId}/checkpoints`), orderBy("number"));
                const submissionsQuery = query(collection(db, "submissions"), where("teamId", "==", teamId), where("eventId", "==", currentEventId));
                const checkpointsSnapshot = await getDocs(checkpointsQuery);
                const checkpoints = checkpointsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                onSnapshot(submissionsQuery, (snapshot) => {
                    const submissions = {};
                    snapshot.forEach(doc => { submissions[doc.data().checkpointId] = { id: doc.id, ...doc.data() }; });
                    const checkpointsGrid = document.getElementById('checkpointsGrid');
                    checkpointsGrid.innerHTML = '';
                    checkpoints.forEach(checkpoint => {
                        const submission = submissions[checkpoint.id];
                        const isCompleted = !!submission;
                        const card = document.createElement('div');
                        card.className = `p-4 rounded-lg shadow-md flex flex-col items-center justify-center transition-all ${isCompleted ? 'bg-green-500 text-white' : 'bg-white'} ${!isReadOnly ? 'cursor-pointer hover:bg-gray-100' : 'cursor-default'}`;
                        card.innerHTML = `<span class="text-4xl font-bold">${checkpoint.number}</span><span class="text-sm mt-1">${isCompleted ? 'Completato' : 'Da visitare'}</span>${isCompleted ? '<i data-lucide="check-circle" class="w-6 h-6 mt-2"></i>' : '<i data-lucide="map-pin" class="w-6 h-6 mt-2"></i>'}`;
                        if (!isReadOnly || isCompleted) {
                           card.addEventListener('click', () => openCheckpoint(checkpoint, teamId, isCompleted, submission, isReadOnly));
                        }
                        checkpointsGrid.appendChild(card);
                    });
                    lucide.createIcons();
                    showView('participantView');
                }, (error) => { console.error("Game submissions listener error:", error); });
            } catch (error) {
                 showModal("Errore Critico", "Impossibile caricare i dati della gara. Dettagli: " + error.message, false, () => signOut(auth));
            }
         }
        async function openCheckpoint(checkpoint, teamId, isCompleted, submission, isReadOnly = false) {
            showView('checkpointView');
            let imageUrlHtml = checkpoint.imageUrl ? `<div class="bg-gray-200 rounded-lg mb-4"><img src="${checkpoint.imageUrl}" alt="Immagine del punto" class="w-full h-48 object-contain rounded-lg"></div>` : '';
            document.getElementById('checkpointDetail').innerHTML = `${imageUrlHtml}<h2 class="text-2xl font-bold mb-4">Punto #${checkpoint.number}</h2><p class="text-lg bg-gray-100 p-4 rounded-md">${checkpoint.question}</p>`;
            document.getElementById('checkpointIdInput').value = checkpoint.id;
            document.getElementById('teamIdInput').value = teamId;
            const answerInput = document.getElementById('answer');
            const photoInput = document.getElementById('photo');
            const submitButton = submissionForm.querySelector('button[type="submit"]');
            const deleteButton = document.getElementById('deleteSubmissionBtn');
            if (isCompleted) {
                answerInput.value = submission.answer;
                answerInput.disabled = true;
                photoInput.classList.add('hidden');
                submitButton.classList.add('hidden');
                deleteButton.classList.toggle('hidden', isReadOnly);
                deleteButton.onclick = () => deleteSubmission(submission.id, teamId, checkpoint.id);
                document.getElementById('photo-preview-container').innerHTML = `<p class="mt-4">Foto inviata:</p><img src="${submission.photoUrl}" class="mt-2 rounded-md max-w-sm w-full" />`;
            } else {
                answerInput.value = ''; answerInput.disabled = isReadOnly; photoInput.value = '';
                photoInput.classList.toggle('hidden', isReadOnly); submitButton.classList.toggle('hidden', isReadOnly);
                deleteButton.classList.add('hidden');
                submitButton.disabled = false; submitButton.textContent = 'Invia Risposta';
                document.getElementById('photo-preview-container').innerHTML = '';
            }
        }
        async function deleteSubmission(submissionId, teamId, checkpointId) {
            showModal("Conferma Cancellazione", "Sei sicuro di voler cancellare la tua risposta? Potrai inviarne una nuova.", true, async () => {
                try {
                    const submissionRef = doc(db, "submissions", submissionId);
                    const photoRef = ref(storage, `submissions/${currentEventId}/${teamId}_${checkpointId}.jpg`);
                    await deleteDoc(submissionRef);
                    await deleteObject(photoRef);
                    showModal("Successo", "Risposta cancellata. Ora puoi inviarne una nuova.");
                    showView('participantView');
                } catch(error) { showModal("Errore", "Cancellazione fallita: " + error.message); }
            });
         }
        document.getElementById('backToGrid').addEventListener('click', () => showView('participantView'));
        document.getElementById('submissionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitButton = submissionForm.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.innerHTML = `<i data-lucide="loader-2" class="animate-spin mr-2"></i> Caricamento...`;
            lucide.createIcons();
            const teamId = document.getElementById('teamIdInput').value;
            const checkpointId = document.getElementById('checkpointIdInput').value;
            const answer = document.getElementById('answer').value;
            const photoFile = document.getElementById('photo').files[0];
            if (!photoFile) { showModal("Errore", "Devi caricare una foto!"); submitButton.disabled = false; submitButton.textContent = 'Invia Risposta'; return; }
            try {
                const eventDoc = await getDoc(doc(db, "events", currentEventId));
                if (eventDoc.data().status === 'finished') { throw new Error("La gara è terminata. Non è più possibile inviare risposte."); }
                
                const photoRef = ref(storage, `submissions/${currentEventId}/${teamId}_${checkpointId}.jpg`);
                await uploadBytes(photoRef, photoFile);
                const photoUrl = await getDownloadURL(photoRef);
                await addDoc(collection(db, "submissions"), { eventId: currentEventId, teamId, checkpointId, answer, photoUrl, timestamp: new Date() });
                showModal("Successo", "Risposta inviata con successo!");
                showView('participantView');
            } catch (error) { showModal("Errore", "Invio fallito: " + error.message); submitButton.disabled = false; submitButton.textContent = 'Invia Risposta';}
        });
        function showSubmissionDetail(submission, checkpoint, isCorrect, team) {
             document.getElementById('organizerDetailContent').innerHTML = `<p><strong>Squadra:</strong> ${team.name}</p><p><strong>Risposta Data:</strong> ${submission.answer}</p><p><strong>Risposta Corretta:</strong> ${checkpoint.correctAnswer}</p><p><strong>Punteggio Assegnato:</strong> ${isCorrect ? (checkpoint.points || 0) : 0}</p><p class="mt-4"><strong>Foto:</strong></p><img src="${submission.photoUrl}" alt="Foto sottomessa" class="mt-2 rounded-lg w-full max-w-lg">`;
             showView('organizerDetailView');
        }
        document.getElementById('backToOrganizer').addEventListener('click', () => showView('organizerDashboardView'));
        document.getElementById('manageCpBtn').addEventListener('click', () => initOrganizerAdmin());
        document.getElementById('manageTeamsBtn').addEventListener('click', () => initOrganizerTeamsView());
        async function initOrganizerTeamsView() {
            showView('organizerTeamsView');
            const teamsList = document.getElementById('teamsList');
            onSnapshot(query(collection(db, `events/${currentEventId}/teams`)), (snapshot) => {
                teamsList.innerHTML = snapshot.empty ? '<p>Ancora nessuna squadra iscritta.</p>' : '';
                snapshot.forEach(doc => {
                    const item = document.createElement('div');
                    item.className = 'p-3 bg-gray-100 rounded-md flex justify-between items-center';
                    item.innerHTML = `<p class="font-medium">${doc.data().name}</p>`;
                    teamsList.appendChild(item);
                });
            });
        }
        document.getElementById('backToDashboardFromTeams').addEventListener('click', () => showView('organizerDashboardView'));
        async function initOrganizerAdmin() {
            showView('organizerAdminView');
            const checkpointsList = document.getElementById('checkpointsList');
            const checkpointsQuery = query(collection(db, `events/${currentEventId}/checkpoints`), orderBy("number"));
            onSnapshot(checkpointsQuery, (snapshot) => {
                checkpointsList.innerHTML = snapshot.empty ? '<p>Nessun punto di controllo creato.</p>' : '';
                snapshot.docs.forEach(doc => {
                    const cp = doc.data(); const id = doc.id;
                    const item = document.createElement('div');
                    item.className = 'p-3 bg-gray-100 rounded-md flex justify-between items-center';
                    item.innerHTML = `<div><p class="font-bold">Punto #${cp.number} (${cp.points} pt.)</p><p class="text-sm text-gray-600">Q: ${cp.question} / A: ${cp.correctAnswer}</p></div><div class="flex space-x-2"><button title="Modifica" class="edit-btn p-2 text-blue-600 hover:text-blue-800"><i data-lucide="pencil" class="pointer-events-none"></i></button><button title="Elimina" class="delete-btn p-2 text-red-600 hover:text-red-800"><i data-lucide="trash-2" class="pointer-events-none"></i></button></div>`;
                    item.querySelector('.edit-btn').addEventListener('click', () => startEditCheckpoint(id, cp));
                    item.querySelector('.delete-btn').addEventListener('click', () => deleteCheckpoint(id));
                    checkpointsList.appendChild(item);
                });
                lucide.createIcons();
            });
        }
        async function deleteCheckpoint(id) {
            showModal("Conferma Eliminazione", "Sei sicuro di voler eliminare questo punto di controllo? L'azione è irreversibile.", true, async () => {
                try { await deleteDoc(doc(db, `events/${currentEventId}/checkpoints`, id)); } catch (error) { showModal("Errore", "Eliminazione fallita: " + error.message); }
            });
        }
        function startEditCheckpoint(id, data) {
            document.getElementById('editCheckpointId').value = id;
            const form = document.getElementById('addCheckpointForm');
            form.number.value = data.number; form.question.value = data.question;
            form.correctAnswer.value = data.correctAnswer; form.points.value = data.points;
            form.timeBonus.value = data.timeBonus || '';
            form.bonusPoints.value = data.bonusPoints || '';
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.textContent = 'Salva Modifiche';
            submitBtn.classList.replace('bg-green-600', 'bg-yellow-500');
            submitBtn.classList.replace('hover:bg-green-700', 'hover:bg-yellow-600');
            document.getElementById('cancelEditBtn').classList.remove('hidden');
        }
        function resetCheckpointForm() {
            const form = document.getElementById('addCheckpointForm');
            form.reset(); document.getElementById('editCheckpointId').value = '';
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.textContent = 'Aggiungi Punto';
            submitBtn.classList.replace('bg-yellow-500', 'bg-green-600');
            submitBtn.classList.replace('hover:bg-yellow-600', 'hover:bg-green-700');
            document.getElementById('cancelEditBtn').classList.add('hidden');
        }
        document.getElementById('cancelEditBtn').addEventListener('click', resetCheckpointForm);
        document.getElementById('addCheckpointForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const data = {
                number: parseInt(form.number.value),
                question: form.question.value,
                correctAnswer: form.correctAnswer.value,
                points: parseInt(form.points.value),
                timeBonus: parseInt(form.timeBonus.value) || 0,
                bonusPoints: parseInt(form.bonusPoints.value) || 0
            };
            const checkpointId = document.getElementById('editCheckpointId').value;
            const imageFile = form.image.files[0];
            try {
                let finalCheckpointId = checkpointId;
                if (!checkpointId) {
                    const tempDoc = await addDoc(collection(db, `events/${currentEventId}/checkpoints`), data);
                    finalCheckpointId = tempDoc.id;
                }
                if (imageFile) {
                    const imageRef = ref(storage, `checkpoints/${currentEventId}/${finalCheckpointId}.jpg`);
                    await uploadBytes(imageRef, imageFile);
                    data.imageUrl = await getDownloadURL(imageRef);
                }
                const docRef = doc(db, `events/${currentEventId}/checkpoints`, finalCheckpointId);
                await updateDoc(docRef, data);
                resetCheckpointForm();
            } catch(error) { showModal("Errore", "Salvataggio fallito: " + error.message); }
        });
        document.getElementById('backToDashboardBtn').addEventListener('click', () => showView('organizerDashboardView'));
        
        showView('loadingView');
        lucide.createIcons();
    </script>
    <style> .animate-spin { animation: spin 1s linear infinite; } @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } } .pointer-events-none { pointer-events: none; } </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800">
    <div id="appContainer" class="max-w-7xl mx-auto p-4 min-h-screen">
        
        <div id="loadingView" class="hidden">
             <div class="flex flex-col items-center justify-center h-screen"><i data-lucide="loader-2" class="w-16 h-16 animate-spin text-indigo-600"></i><p class="mt-4 text-lg">Caricamento...</p></div>
        </div>
        
        <div id="loginView" class="hidden">
            <div class="bg-white p-8 rounded-xl shadow-lg mt-10 max-w-md mx-auto">
                <h1 class="text-3xl font-bold text-center text-blue-600 mb-2">Orienteering Challenge</h1>
                <p class="text-center text-gray-500 mb-8">Accedi o registra il tuo account</p>
                <form id="loginForm" class="mb-6 space-y-4">
                    <h2 class="text-xl font-semibold text-center">Login</h2>
                    <div><label for="login-email" class="block mb-1 font-medium">Email</label><input type="email" id="login-email" name="email" required class="w-full p-2 border rounded-md"></div>
                    <div><label for="login-password" class="block mb-1 font-medium">Password</label><input type="password" id="login-password" name="password" required class="w-full p-2 border rounded-md"></div>
                    <button type="submit" class="w-full bg-blue-600 text-white p-3 rounded-md font-bold">Accedi</button>
                </form>
                <hr class="my-6">
                <form id="registerForm" class="space-y-4">
                    <h2 class="text-xl font-semibold text-center">Registrazione</h2>
                    <div><label for="register-email" class="block mb-1 font-medium">Email</label><input type="email" id="register-email" name="email" required class="w-full p-2 border rounded-md"></div>
                    <div><label for="register-password" class="block mb-1 font-medium">Password (min. 6 caratteri)</label><input type="password" id="register-password" name="password" required class="w-full p-2 border rounded-md"></div>
                    <button type="submit" class="w-full bg-green-600 text-white p-3 rounded-md font-bold">Registrati</button>
                </form>
            </div>
        </div>
        
        <div id="organizerHomeView" class="hidden">
            <header class="bg-white p-4 rounded-xl shadow-lg mb-6 flex justify-between items-center">
                <h1 class="text-3xl font-bold text-indigo-600">I Tuoi Eventi</h1>
                <button id="logout-organizer-home" class="bg-red-500 text-white p-2 rounded-full hover:bg-red-600"><i data-lucide="log-out" class="w-5 h-5"></i></button>
            </header>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-xl shadow-lg"><h2 class="text-2xl font-bold mb-4">Crea Nuovo Evento</h2><form id="createEventForm" class="space-y-4"><div><label for="eventName" class="block font-medium">Nome Evento</label><input type="text" id="eventName" required class="w-full p-2 border rounded-md"></div><button type="submit" class="w-full bg-green-600 text-white p-3 rounded-md font-bold hover:bg-green-700">Crea Evento</button></form></div>
                <div class="bg-white p-6 rounded-xl shadow-lg"><h2 class="text-2xl font-bold mb-4">Eventi Esistenti</h2><div id="organizerEventsList" class="space-y-4"></div></div>
            </div>
        </div>

        <div id="joinEventView" class="hidden">
            <div class="bg-white p-8 rounded-xl shadow-lg mt-10 max-w-md mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-2xl font-bold text-blue-600">Unisciti a un Evento</h1>
                    <button id="logout-join" class="text-gray-500 hover:text-red-500"><i data-lucide="log-out" class="w-6 h-6"></i></button>
                </div>
                <form id="joinEventForm" class="space-y-4">
                    <div><label for="joinCode" class="block font-medium">Codice Evento</label><input type="text" id="joinCode" placeholder="GARA-ABCD" required class="w-full p-2 border rounded-md uppercase"></div>
                    <div><label for="teamName" class="block font-medium">Nome Squadra</label><input type="text" id="teamName" required class="w-full p-2 border rounded-md"></div>
                    <button type="submit" class="w-full bg-blue-600 text-white p-3 rounded-md font-bold hover:bg-blue-700">Entra</button>
                </form>
            </div>
        </div>

        <div id="participantLobbyView" class="hidden">
            <div class="bg-white p-8 rounded-xl shadow-lg mt-10 max-w-md mx-auto text-center">
                 <div class="flex justify-end"><button id="logout-lobby" class="text-gray-500 hover:text-red-500"><i data-lucide="log-out" class="w-6 h-6"></i></button></div>
                <i data-lucide="hourglass" class="w-20 h-20 text-yellow-500 mx-auto animate-pulse"></i>
                <h1 id="lobbyEventName" class="text-3xl font-bold mt-4"></h1>
                <p class="mt-4 text-lg text-gray-600">Sei dentro! Attendi che l'organizzatore avvii la gara.</p>
                <p class="mt-2 text-sm text-gray-500">La pagina si aggiornerà automaticamente.</p>
            </div>
        </div>

        <div id="organizerDashboardView" class="hidden">
            <header class="bg-white p-4 rounded-xl shadow-lg mb-6 flex justify-between items-center">
                <div><button id="backToOrganizerHome" class="text-indigo-600 font-semibold flex items-center hover:underline mb-2"><i data-lucide="arrow-left" class="w-5 h-5 mr-2"></i> Torna ai miei eventi</button><h1 class="text-2xl font-bold text-indigo-600">Dashboard Evento</h1></div>
                <div class="flex items-center space-x-2">
                    <button id="startEventBtn" title="Avvia Gara" class="bg-green-500 text-white p-2 rounded-lg font-semibold hover:bg-green-600"><i data-lucide="play" class="w-5 h-5"></i></button>
                    <button id="finishEventBtn" title="Termina Gara" class="bg-red-500 text-white p-2 rounded-lg font-semibold hover:bg-red-600"><i data-lucide="square" class="w-5 h-5"></i></button>
                    <button id="galleryBtn" title="Vedi Galleria Foto" class="bg-teal-500 text-white p-2 rounded-lg font-semibold hover:bg-teal-600"><i data-lucide="gallery-thumbnails" class="w-5 h-5"></i></button>
                    <button id="manageCpBtn" title="Gestisci Punti" class="bg-blue-600 text-white p-2 rounded-lg font-semibold hover:bg-blue-700"><i data-lucide="settings" class="w-5 h-5"></i></button>
                    <button id="manageTeamsBtn" title="Gestisci Squadre" class="bg-purple-600 text-white p-2 rounded-lg font-semibold hover:bg-purple-700"><i data-lucide="users" class="w-5 h-5"></i></button>
                </div>
            </header>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 bg-white p-4 rounded-xl shadow-lg overflow-x-auto"><h2 class="text-xl font-bold mb-4">Monitoraggio Risposte</h2><table id="organizerGrid" class="w-full text-sm"></table></div>
                <div class="bg-white p-4 rounded-xl shadow-lg">
                    <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold">Classifica</h2><button id="exportCsvBtn" title="Esporta in CSV" class="text-gray-500 hover:text-green-600"><i data-lucide="file-down" class="w-6 h-6"></i></button></div>
                    <table class="w-full"><thead class="bg-gray-200"><tr><th class="p-2 text-center w-12">Pos.</th><th class="p-2 text-left">Squadra</th><th class="p-2 text-center">Punti Fatti</th><th class="p-2 text-right">Punteggio</th></tr></thead><tbody id="leaderboardBody"></tbody></table>
                </div>
            </div>
        </div>
        
        <div id="galleryView" class="hidden">
             <div class="bg-white p-6 rounded-xl shadow-lg">
                <button id="backToDashboardFromGallery" class="mb-6 text-indigo-600 font-semibold flex items-center hover:underline"><i data-lucide="arrow-left" class="w-5 h-5 mr-2"></i> Torna alla Dashboard</button>
                <h2 class="text-3xl font-bold mb-6 text-center">Galleria Fotografica dell'Evento</h2>
                <div id="galleryGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
            </div>
        </div>
        
        <div id="organizerTeamsView" class="hidden">
            <div class="bg-white p-6 rounded-xl shadow-lg max-w-2xl mx-auto">
                <button id="backToDashboardFromTeams" class="mb-6 text-indigo-600 font-semibold flex items-center hover:underline"><i data-lucide="arrow-left" class="w-5 h-5 mr-2"></i> Torna alla Dashboard</button>
                <h2 class="text-2xl font-bold mb-4">Squadre Iscritte</h2>
                <div id="teamsList" class="space-y-3"></div>
            </div>
        </div>

        <div id="organizerAdminView" class="hidden">
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <button id="backToDashboardBtn" class="mb-6 text-indigo-600 font-semibold flex items-center hover:underline"><i data-lucide="arrow-left" class="w-5 h-5 mr-2"></i> Torna alla Dashboard</button>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <h2 class="text-2xl font-bold mb-4">Aggiungi / Modifica Punto</h2>
                        <form id="addCheckpointForm" class="space-y-4">
                            <input type="hidden" id="editCheckpointId">
                            <div><label for="cp-number" class="block font-medium">Numero Punto</label><input type="number" id="cp-number" name="number" required class="w-full p-2 border rounded-md"></div>
                            <div><label for="cp-image" class="block font-medium">Immagine del Punto (Opzionale)</label><input type="file" id="cp-image" name="image" accept="image/*" class="w-full text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:font-semibold file:bg-indigo-100 file:text-indigo-700 hover:file:bg-indigo-200"></div>
                            <div><label for="cp-question" class="block font-medium">Domanda</label><textarea id="cp-question" name="question" required rows="2" class="w-full p-2 border rounded-md"></textarea></div>
                            <div><label for="cp-correctAnswer" class="block font-medium">Risposta Esatta</label><input type="text" id="cp-correctAnswer" name="correctAnswer" required class="w-full p-2 border rounded-md"></div>
                            <div><label for="cp-points" class="block font-medium">Punteggio Base</label><input type="number" id="cp-points" name="points" required class="w-full p-2 border rounded-md"></div>
                            <div class="grid grid-cols-2 gap-4"><label class="block font-medium col-span-2">Bonus a Tempo (Opzionale)</label><div><label for="cp-timeBonus" class="text-sm">Entro (minuti)</label><input type="number" id="cp-timeBonus" name="timeBonus" placeholder="Es. 30" class="w-full p-2 border rounded-md"></div><div><label for="cp-bonusPoints" class="text-sm">Punti Bonus</label><input type="number" id="cp-bonusPoints" name="bonusPoints" placeholder="Es. 50" class="w-full p-2 border rounded-md"></div></div>
                            <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white p-3 rounded-md font-bold transition-colors">Aggiungi Punto</button>
                            <button type="button" id="cancelEditBtn" class="hidden w-full bg-gray-500 text-white p-3 rounded-md font-bold hover:bg-gray-600 mt-2">Annulla Modifica</button>
                        </form>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold mb-4">Punti Esistenti</h2>
                        <div id="checkpointsList" class="space-y-3 max-h-[70vh] overflow-y-auto pr-2"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="participantView" class="hidden">
            <header class="bg-white p-4 rounded-xl shadow-lg mb-6 flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-blue-600">Punti di Controllo</h1>
                    <p id="participant-team-name-display" class="text-gray-600"></p>
                </div>
                <button id="logout-participant" class="bg-red-500 text-white p-2 rounded-full hover:bg-red-600"><i data-lucide="log-out" class="w-5 h-5"></i></button>
            </header>
             <div id="game-finished-banner" class="hidden bg-yellow-400 text-yellow-900 p-4 rounded-lg mb-6 text-center font-semibold">GARA TERMINATA</div>
            <div id="checkpointsGrid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4"></div>
        </div>

        <div id="checkpointView" class="hidden">
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <button id="backToGrid" class="mb-4 text-blue-600 font-semibold flex items-center hover:underline"> <i data-lucide="arrow-left" class="w-5 h-5 mr-2"></i> Torna alla Mappa </button>
                <div id="checkpointDetail" class="mb-6"></div>
                <form id="submissionForm">
                    <input type="hidden" id="checkpointIdInput"><input type="hidden" id="teamIdInput">
                    <div class="mb-4"><label for="answer" class="block text-lg font-medium mb-2">La tua risposta:</label><input type="text" id="answer" name="answer" required class="w-full p-3 border rounded-md text-lg"></div>
                    <div class="mb-6">
                        <p class="block text-lg font-medium mb-2">Carica la foto:</p>
                        <input type="file" id="photo" name="photo" accept="image/*" required class="w-full text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:font-semibold file:bg-blue-100 file:text-blue-700 hover:file:bg-blue-200">
                        <div id="photo-preview-container" class="mt-4"></div>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white p-4 rounded-md text-lg font-bold hover:bg-blue-700 flex items-center justify-center">Invia Risposta</button>
                    <button type="button" id="deleteSubmissionBtn" class="hidden w-full bg-red-600 text-white p-3 rounded-md font-bold hover:bg-red-700 mt-4">Cancella Risposta</button>
                </form>
            </div>
        </div>

        <div id="organizerDetailView" class="hidden">
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <button id="backToOrganizer" class="mb-4 text-indigo-600 font-semibold flex items-center hover:underline"> <i data-lucide="arrow-left" class="w-5 h-5 mr-2"></i> Torna alla Dashboard </button>
                <h2 class="text-2xl font-bold mb-4">Dettaglio Risposta</h2>
                <div id="organizerDetailContent" class="space-y-4"></div>
            </div>
        </div>

        <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full">
                <h3 id="modalTitle" class="text-xl font-bold mb-4"></h3>
                <p id="modalMessage" class="text-gray-600 mb-6"></p>
                <div class="flex justify-end space-x-4">
                    <button id="modalCancelBtn" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Annulla</button>
                    <button id="modalConfirmBtn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Conferma</button>
                </div>
            </div>
        </div>

    </div>
</body>
</html>

