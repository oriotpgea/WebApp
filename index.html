<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orienteering Web Challenge</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&family=Roboto:wght@400;500&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="style.css">
    <script type="module" src="script.js" defer></script>

</head>
<body class="bg-gray-100">
    <div id="appContainer" class="max-w-7xl mx-auto p-4 min-h-screen">
        
        <div id="loadingView" class="hidden">
             <div class="flex flex-col items-center justify-center h-screen"><i data-lucide="loader-2" class="w-16 h-16 animate-spin text-green-700"></i><p class="mt-4 text-lg">Caricamento...</p></div>
        </div>
        
        <div id="loginView" class="hidden">
            <div class="bg-white p-8 rounded-xl shadow-lg mt-10 max-w-md mx-auto">
                <h1 class="text-3xl font-bold text-center text-green-800 mb-2">Orienteering Challenge</h1>
                <p class="text-center text-gray-600 mb-8">Accedi o registra il tuo account</p>
                <form id="loginForm" class="mb-6 space-y-4">
                    <h2 class="text-xl font-semibold text-center">Login</h2>
                    <div><label for="login-email" class="block mb-1 font-medium">Email</label><input type="email" id="login-email" name="email" required class="w-full p-2 border rounded-md"></div>
                    <div><label for="login-password" class="block mb-1 font-medium">Password</label><input type="password" id="login-password" name="password" required class="w-full p-2 border rounded-md"></div>
                    <button type="submit" class="w-full p-3 rounded-md font-bold btn btn-secondary">Accedi</button>
                </form>
                <hr class="my-6">
                <form id="registerForm" class="space-y-4">
                    <h2 class="text-xl font-semibold text-center">Registrazione</h2>
                    <div><label for="register-email" class="block mb-1 font-medium">Email</label><input type="email" id="register-email" name="email" required class="w-full p-2 border rounded-md"></div>
                    <div><label for="register-password" class="block mb-1 font-medium">Password (min. 6 caratteri)</label><input type="password" id="register-password" name="password" required class="w-full p-2 border rounded-md"></div>
                    <button type="submit" class="w-full p-3 rounded-md font-bold btn btn-secondary">Registrati</button>
                </form>
            </div>
        </div>
        
        <div id="organizerHomeView" class="hidden">
            <header class="bg-white p-4 rounded-xl shadow-lg mb-6 flex justify-between items-center">
                <h1 class="text-3xl font-bold text-green-800">I Tuoi Eventi</h1>
                <button id="logout-organizer-home" class="btn-icon bg-red-500 hover:bg-red-600"><i data-lucide="log-out" class="w-5 h-5"></i></button>
            </header>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-xl shadow-lg"><h2 class="text-2xl font-bold mb-4">Crea Nuovo Evento</h2><form id="createEventForm" class="space-y-4"><div><label for="eventName" class="block font-medium">Nome Evento</label><input type="text" id="eventName" required class="w-full p-2 border rounded-md"></div><button type="submit" class="w-full p-3 rounded-md font-bold btn btn-secondary">Crea Evento</button></form></div>
                <div class="bg-white p-6 rounded-xl shadow-lg"><h2 class="text-2xl font-bold mb-4">Eventi Esistenti</h2><div id="organizerEventsList" class="space-y-4"></div></div>
            </div>
        </div>

        <div id="joinEventView" class="hidden">
            <div class="bg-white p-8 rounded-xl shadow-lg mt-10 max-w-md mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-2xl font-bold text-green-800">Unisciti a un Evento</h1>
                    <button id="logout-join" class="text-gray-500 hover:text-red-500"><i data-lucide="log-out" class="w-6 h-6"></i></button>
                </div>
                <form id="joinEventForm" class="space-y-4">
                    <div><label for="joinCode" class="block font-medium">Codice Evento</label><input type="text" id="joinCode" placeholder="GARA-ABCD" required class="w-full p-2 border rounded-md uppercase"></div>
                    <div><label for="teamName" class="block font-medium">Nome Squadra</label><input type="text" id="teamName" required class="w-full p-2 border rounded-md"></div>
                    <button type="submit" class="w-full p-3 rounded-md font-bold btn btn-primary">Entra</button>
                </form>
            </div>
        </div>

        <div id="participantLobbyView" class="hidden">
            <div class="bg-white p-8 rounded-xl shadow-lg mt-10 max-w-md mx-auto text-center">
                 <div class="flex justify-end"><button id="logout-lobby" class="text-gray-500 hover:text-red-500"><i data-lucide="log-out" class="w-6 h-6"></i></button></div>
                <i data-lucide="hourglass" class="w-20 h-20 text-orange-500 mx-auto animate-pulse"></i>
                <h1 id="lobbyEventName" class="text-3xl font-bold mt-4"></h1>
                <p class="mt-4 text-lg text-gray-600">Sei dentro! Attendi che l'organizzatore avvii la gara.</p>
                <p class="mt-2 text-sm text-gray-500">La pagina si aggiornerà automaticamente.</p>
            </div>
        </div>

        <div id="organizerDashboardView" class="hidden">
            <header class="bg-white p-4 rounded-xl shadow-lg mb-6 flex justify-between items-center">
                <div><button id="backToOrganizerHome" class="text-green-700 font-semibold flex items-center hover:underline mb-2"><i data-lucide="arrow-left" class="w-5 h-5 mr-2"></i> Torna ai miei eventi</button><h1 class="text-2xl font-bold text-green-800">Dashboard Evento</h1></div>
                <div class="flex items-center space-x-2">
                    <button id="startEventBtn" title="Avvia Gara" class="btn-icon bg-green-500 hover:bg-green-600"><i data-lucide="play" class="w-5 h-5"></i></button>
                    <button id="finishEventBtn" title="Termina Gara" class="btn-icon bg-red-500 hover:bg-red-600"><i data-lucide="square" class="w-5 h-5"></i></button>
                    <button id="activityLogBtn" title="Vedi Log Attività" class="btn-icon bg-brand-green hover:bg-brand-green-dark"><i data-lucide="history" class="w-5 h-5"></i></button>
                    <button id="manageCpBtn" title="Gestisci Punti" class="btn-icon bg-brand-green hover:bg-brand-green-dark"><i data-lucide="settings" class="w-5 h-5"></i></button>
                    <button id="manageTeamsBtn" title="Gestisci Squadre" class="btn-icon bg-brand-orange hover:bg-brand-orange-dark"><i data-lucide="users" class="w-5 h-5"></i></button>
                </div>
            </header>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 bg-white p-4 rounded-xl shadow-lg overflow-x-auto"><h2 class="text-xl font-bold mb-4">Monitoraggio Risposte</h2><table id="organizerGrid" class="w-full text-sm"></table></div>
                <div class="bg-white p-4 rounded-xl shadow-lg">
                    <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold">Classifica</h2><button id="exportCsvBtn" title="Esporta in CSV" class="text-gray-500 hover:text-green-600"><i data-lucide="file-down" class="w-6 h-6"></i></button></div>
                    <table class="w-full"><thead class="bg-gray-200"><tr><th class="p-2 text-center w-12">Pos.</th><th class="p-2 text-left">Squadra</th><th class="p-2 text-center">Punti Fatti</th><th class="p-2 text-right">Punteggio</th></tr></thead><tbody id="leaderboardBody"></tbody></table>
                </div>
            </div>
        </div>
        
        <div id="activityLogView" class="hidden">
             <div class="bg-white p-6 rounded-xl shadow-lg">
                <button id="backToDashboardFromLog" class="mb-6 text-green-700 font-semibold flex items-center hover:underline"><i data-lucide="arrow-left" class="w-5 h-5 mr-2"></i> Torna alla Dashboard</button>
                <h2 class="text-3xl font-bold mb-6 text-center">Log Attività in Tempo Reale</h2>
                <div id="activityLogContainer" class="space-y-4">
                    </div>
            </div>
        </div>
        
        <div id="organizerTeamsView" class="hidden">
            <div class="bg-white p-6 rounded-xl shadow-lg max-w-2xl mx-auto">
                <button id="backToDashboardFromTeams" class="mb-6 text-green-700 font-semibold flex items-center hover:underline"><i data-lucide="arrow-left" class="w-5 h-5 mr-2"></i> Torna alla Dashboard</button>
                <h2 class="text-2xl font-bold mb-4">Squadre Iscritte</h2>
                <div id="teamsList" class="space-y-3"></div>
            </div>
        </div>

        <div id="organizerAdminView" class="hidden">
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <button id="backToDashboardBtn" class="mb-6 text-green-700 font-semibold flex items-center hover:underline"><i data-lucide="arrow-left" class="w-5 h-5 mr-2"></i> Torna alla Dashboard</button>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <h2 class="text-2xl font-bold mb-4">Aggiungi / Modifica Punto</h2>
                        <form id="addCheckpointForm" class="space-y-4">
                            <input type="hidden" id="editCheckpointId">
                            <div><label for="cp-number" class="block font-medium">Numero Punto</label><input type="number" id="cp-number" name="number" required class="w-full p-2 border rounded-md"></div>
                            <div><label for="cp-image" class="block font-medium">Immagine del Punto (Opzionale)</label><input type="file" id="cp-image" name="image" accept="image/*" class="w-full text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:font-semibold file:bg-indigo-100 file:text-indigo-700 hover:file:bg-indigo-200"></div>
                            <div><label for="cp-question" class="block font-medium">Domanda</label><textarea id="cp-question" name="question" required rows="2" class="w-full p-2 border rounded-md"></textarea></div>
                            <div><label for="cp-correctAnswer" class="block font-medium">Risposta Esatta</label><input type="text" id="cp-correctAnswer" name="correctAnswer" required class="w-full p-2 border rounded-md"></div>
                            <div><label for="cp-points" class="block font-medium">Punteggio Base</label><input type="number" id="cp-points" name="points" required class="w-full p-2 border rounded-md"></div>
                            <div class="grid grid-cols-2 gap-4"><label class="block font-medium col-span-2">Bonus a Tempo (Opzionale)</label><div><label for="cp-timeBonus" class="text-sm">Entro (minuti)</label><input type="number" id="cp-timeBonus" name="timeBonus" placeholder="Es. 30" class="w-full p-2 border rounded-md"></div><div><label for="cp-bonusPoints" class="text-sm">Punti Bonus</label><input type="number" id="cp-bonusPoints" name="bonusPoints" placeholder="Es. 50" class="w-full p-2 border rounded-md"></div></div>
                            <button type="submit" class="w-full p-3 rounded-md font-bold transition-colors btn btn-secondary">Aggiungi Punto</button>
                            <button type="button" id="cancelEditBtn" class="hidden w-full bg-gray-500 text-white p-3 rounded-md font-bold hover:bg-gray-600 mt-2">Annulla Modifica</button>
                        </form>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold mb-4">Punti Esistenti</h2>
                        <div id="checkpointsList" class="space-y-3 max-h-[70vh] overflow-y-auto pr-2"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="participantView" class="hidden">
            <header class="bg-white p-4 rounded-xl shadow-lg mb-6 flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-green-800">Punti di Controllo</h1>
                    <p id="participant-team-name-display" class="text-gray-600"></p>
                </div>
                <button id="logout-participant" class="btn-icon bg-red-500 hover:bg-red-600"><i data-lucide="log-out" class="w-5 h-5"></i></button>
            </header>
             <div id="game-finished-banner" class="hidden bg-yellow-400 text-yellow-900 p-4 rounded-lg mb-6 text-center font-semibold">GARA TERMINATA</div>
            <div id="checkpointsGrid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4"></div>
        </div>
        
        <div id="checkpointView" class="hidden">
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <button id="backToGrid" class="mb-4 text-green-700 font-semibold flex items-center hover:underline"> <i data-lucide="arrow-left" class="w-5 h-5 mr-2"></i> Torna alla Mappa </button>
                <div id="checkpointDetail" class="mb-6"></div>
                <form id="submissionForm">
                    <input type="hidden" id="checkpointIdInput"><input type="hidden" id="teamIdInput">
                    <div class="mb-4"><label for="answer" class="block text-lg font-medium mb-2">La tua risposta:</label><input type="text" id="answer" name="answer" required class="w-full p-3 border rounded-md text-lg"></div>
                    <div class="mb-6">
                        <p class="block text-lg font-medium mb-2">Carica la foto:</p>
                        <input type="file" id="photo" name="photo" accept="image/*" required class="w-full text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:font-semibold file:bg-blue-100 file:text-blue-700 hover:file:bg-blue-200">
                        <div id="photo-preview-container" class="mt-4"></div>
                    </div>
                    <button type="submit" class="w-full p-4 rounded-md text-lg font-bold flex items-center justify-center btn btn-primary">Invia Risposta</button>
                    <button type="button" id="deleteSubmissionBtn" class="hidden w-full bg-red-600 text-white p-3 rounded-md font-bold hover:bg-red-700 mt-4">Cancella Risposta</button>
                </form>
            </div>
        </div>

        <div id="organizerDetailView" class="hidden">
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <button id="backToOrganizer" class="mb-4 text-green-700 font-semibold flex items-center hover:underline"> <i data-lucide="arrow-left" class="w-5 h-5 mr-2"></i> Torna alla Dashboard </button>
                <h2 class="text-2xl font-bold mb-4">Dettaglio Risposta</h2>
                <div id="organizerDetailContent" class="space-y-4"></div>
            </div>
        </div>

        <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full">
                <h3 id="modalTitle" class="text-xl font-bold mb-4"></h3>
                <p id="modalMessage" class="text-gray-600 mb-6"></p>
                <div class="flex justify-end space-x-4">
                    <button id="modalCancelBtn" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Annulla</button>
                    <button id="modalConfirmBtn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Conferma</button>
                </div>
            </div>
        </div>

        <div id="photoModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-lg shadow-xl p-4 max-w-2xl w-full relative">
                <button id="closePhotoModalBtn" class="absolute -top-4 -right-4 bg-white rounded-full p-2 shadow-lg hover:bg-gray-200">
                    <i data-lucide="x" class="w-6 h-6 text-gray-800"></i>
                </button>
                <img id="modalImage" src="" alt="Foto della squadra" class="w-full h-auto max-h-[80vh] object-contain rounded">
            </div>
        </div>

    </div>
</body>
</html>

