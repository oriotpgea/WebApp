<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orienteering Web Challenge</title>
    
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        // Funzione che prova ad applicare la configurazione
        function configureTailwind() {
            if (typeof tailwind !== 'undefined') {
                tailwind.config = {
                    theme: {
                        extend: {
                            colors: {
                                'brand-green': '#005935',
                                'brand-orange': '#ff8000',
                            }
                        }
                    }
                };
                console.log("Tailwind configurato correttamente.");
            } else {
                // Se tailwind non è ancora pronto, riprova tra 50ms
                setTimeout(configureTailwind, 50);
            }
        }
        // Avvia il tentativo
        configureTailwind();
    </script>
    
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="style.css">
    
    <script type="module" src="script.js" defer></script>
</head>

<body class="bg-gray-50 text-gray-800 font-body min-h-screen flex flex-col">

    <div id="appContainer" class="w-full max-w-7xl mx-auto p-4 md:p-6 flex-grow">
        
        <div id="loadingView" class="hidden flex flex-col items-center justify-center min-h-[80vh]">
             <i data-lucide="loader-2" class="w-16 h-16 animate-spin text-brand-green"></i>
             <p class="mt-4 text-xl font-heading text-brand-green">Caricamento...</p>
        </div>
        
        <div id="loginView" class="hidden flex items-center justify-center min-h-[80vh]">
            <div class="bg-white p-8 rounded-xl shadow-xl w-full max-w-md border-t-4 border-brand-green">
                <h1 class="text-3xl font-black text-center text-brand-green mb-2">Orienteering Challenge</h1>
                <p class="text-center text-gray-500 mb-8 font-medium">Piattaforma di Gara Digitale</p>
                
                <form id="loginForm" class="space-y-5">
                    <h2 class="text-xl font-bold text-gray-800 border-b pb-2">Accedi</h2>
                    <div>
                        <label for="login-email" class="block mb-1 text-sm font-bold text-gray-700">Email</label>
                        <input type="email" id="login-email" name="email" required class="w-full p-3 border rounded-md bg-gray-50 focus:bg-white">
                    </div>
                    <div class="relative">
                        <label for="login-password" class="block mb-1 text-sm font-bold text-gray-700">Password</label>
                        <input type="password" id="login-password" name="password" required class="w-full p-3 border rounded-md bg-gray-50 focus:bg-white pr-10">
                        <button type="button" class="toggle-password absolute bottom-3 right-3 text-gray-500 hover:text-gray-700" data-target="login-password">
                            <i data-lucide="eye" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <button type="submit" class="w-full p-3 rounded-md font-bold btn btn-secondary shadow-lg">ENTRA</button>
                </form>
                
                <div class="relative my-8">
                    <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-300"></div></div>
                    <div class="relative flex justify-center text-sm"><span class="px-2 bg-white text-gray-500">Oppure registrati</span></div>
                </div>
                
                <form id="registerForm" class="space-y-5">
                    <h2 class="text-xl font-bold text-gray-800 border-b pb-2">Nuovo Account</h2>  
                    <div>
                        <label for="register-email" class="block mb-1 text-sm font-bold text-gray-700">Email</label>
                        <input type="email" id="register-email" name="email" required class="w-full p-3 border rounded-md bg-gray-50 focus:bg-white">
                    </div>
                    <div class="relative">
                        <label for="register-password" class="block mb-1 text-sm font-bold text-gray-700">Password (min. 6 caratteri)</label>
                        <input type="password" id="register-password" name="password" required class="w-full p-3 border rounded-md bg-gray-50 focus:bg-white pr-10">
                        <button type="button" class="toggle-password absolute bottom-3 right-3 text-gray-500 hover:text-gray-700" data-target="register-password">
                            <i data-lucide="eye" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <button type="submit" class="w-full p-3 rounded-md font-bold btn btn-primary shadow-lg">REGISTRATI</button>
                </form>
            </div>
        </div>
        
        <div id="organizerHomeView" class="hidden">
            <header class="bg-white p-6 rounded-xl shadow-md mb-8 flex flex-col sm:flex-row justify-between items-center gap-4 border-l-4 border-brand-green">
                <h1 class="text-3xl font-black text-brand-green">I Tuoi Eventi</h1>
                <button id="logout-organizer-home" class="btn-icon bg-red-500 hover:bg-red-600 shadow-md"><i data-lucide="log-out" class="w-5 h-5"></i></button>
            </header>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-xl shadow-lg h-fit">
                    <h2 class="text-2xl font-bold mb-6 flex items-center"><i data-lucide="plus-circle" class="w-6 h-6 mr-2 text-brand-orange"></i> Crea Nuovo Evento</h2>
                    <form id="createEventForm" class="space-y-4">
                        <div>
                            <label for="eventName" class="block font-bold text-gray-700 mb-1">Nome Evento</label>
                            <input type="text" id="eventName" required class="w-full p-3 border rounded-md bg-gray-50" placeholder="Es. Caccia al Tesoro 2025">
                        </div>
                        <button type="submit" class="w-full p-4 rounded-md font-bold btn btn-secondary text-lg shadow-md">CREA EVENTO</button>
                    </form>
                </div>
                
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold mb-6 flex items-center"><i data-lucide="list" class="w-6 h-6 mr-2 text-brand-green"></i> Eventi Esistenti</h2>
                    <div id="organizerEventsList" class="space-y-4 max-h-[600px] overflow-y-auto pr-2">
                        </div>
                </div>
            </div>
        </div>

        <div id="joinEventView" class="hidden flex items-center justify-center min-h-[80vh]">
            <div class="bg-white p-8 rounded-xl shadow-xl w-full max-w-md border-t-4 border-brand-orange">
                <div class="flex justify-between items-center mb-8 border-b pb-4">
                    <h1 class="text-2xl font-bold text-brand-green">Unisciti a un Evento</h1>
                    <button id="logout-join" class="text-gray-400 hover:text-red-500 transition-colors"><i data-lucide="log-out" class="w-6 h-6"></i></button>
                </div>
                <form id="joinEventForm" class="space-y-6">
                    <div>
                        <label for="joinCode" class="block font-bold text-gray-700 mb-1">Codice Evento</label>
                        <input type="text" id="joinCode" placeholder="GARA-XXXX" required class="w-full p-4 border-2 border-brand-orange/30 rounded-md uppercase text-center text-2xl font-mono tracking-widest focus:border-brand-orange">
                    </div>
                    <div>
                        <label for="teamName" class="block font-bold text-gray-700 mb-1">Nome Squadra</label>
                        <input type="text" id="teamName" required class="w-full p-3 border rounded-md" placeholder="I Campioni">
                    </div>
                    <button type="submit" class="w-full p-4 rounded-md font-bold btn btn-primary text-lg shadow-lg">ENTRA IN GARA</button>
                </form>
            </div>
        </div>

        <div id="participantLobbyView" class="hidden flex items-center justify-center min-h-[70vh]">
            <div class="bg-white p-10 rounded-xl shadow-2xl max-w-lg mx-auto text-center w-full relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-brand-green to-brand-orange"></div>
                <div class="absolute top-4 right-4">
                    <button id="logout-lobby" class="text-gray-400 hover:text-red-500"><i data-lucide="log-out" class="w-6 h-6"></i></button>
                </div>
                
                <div class="mb-6 flex justify-center">
                    <div class="bg-orange-100 p-4 rounded-full">
                        <i data-lucide="hourglass" class="w-16 h-16 text-brand-orange animate-pulse"></i>
                    </div>
                </div>
                
                <h1 id="lobbyEventName" class="text-3xl font-black text-gray-800 mb-2"></h1>
                <div class="bg-green-50 text-green-800 px-4 py-2 rounded-full inline-block font-bold text-sm mb-6">
                    SEI ISCRITTO
                </div>
                
                <p class="text-xl text-gray-600 leading-relaxed">Attendi che l'organizzatore<br>avvii la gara.</p>
                <p class="mt-8 text-sm text-gray-400 animate-pulse">La pagina si aggiornerà automaticamente...</p>
            </div>
        </div>

        <div id="organizerDashboardView" class="hidden">
            <header class="bg-white p-4 md:p-6 rounded-xl shadow-md mb-6 flex flex-col md:flex-row justify-between items-center gap-4 border-l-4 border-brand-green">
                <div class="flex gap-2 bg-gray-100 p-1 rounded-lg">
                    <button id="refreshDashboardBtn" title="Aggiorna Dati" class="btn-icon bg-blue-500 hover:bg-blue-600"><i data-lucide="refresh-cw" class="w-5 h-5"></i></button>
                    <div class="w-px h-6 bg-gray-300 mx-1 self-center"></div> <button id="startEventBtn" title="Avvia Gara" class="btn-icon bg-green-600 hover:bg-green-700"><i data-lucide="play" class="w-5 h-5"></i></button>
                    <button id="finishEventBtn" title="Termina Gara" class="btn-icon bg-red-600 hover:bg-red-700"><i data-lucide="square" class="w-5 h-5"></i></button>
                </div>
                <div class="flex flex-col items-start">
                    <button id="backToOrganizerHome" class="text-brand-green font-bold text-sm flex items-center hover:underline mb-1">
                        <i data-lucide="arrow-left" class="w-4 h-4 mr-1"></i> I miei eventi
                    </button>
                    <h1 class="text-2xl md:text-3xl font-black text-gray-800">Dashboard Evento</h1>
                </div>
                <div class="flex flex-wrap justify-center gap-2">
                    <div class="flex gap-2">
                        <button id="activityLogBtn" title="Log Attività" class="btn-icon bg-blue-600 hover:bg-blue-700"><i data-lucide="history" class="w-5 h-5"></i></button>
                        <button id="manageCpBtn" title="Gestisci Punti" class="btn-icon bg-brand-green hover:bg-[#004d2c]"><i data-lucide="map" class="w-5 h-5"></i></button>
                        <button id="manageTeamsBtn" title="Gestisci Squadre" class="btn-icon bg-brand-orange hover:bg-[#e67300]"><i data-lucide="users" class="w-5 h-5"></i></button>
                    </div>
                </div>
            </header>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 bg-white rounded-xl shadow-lg flex flex-col overflow-hidden h-[600px]">
                    <div class="p-4 border-b bg-gray-50 flex justify-between items-center">
                        <h2 class="text-xl font-bold text-gray-700">Monitoraggio Tempo Reale</h2>
                    </div>
                    <div class="overflow-auto flex-grow p-0">
                        <table id="organizerGrid" class="w-full text-sm text-left border-collapse">
                            </table>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-lg flex flex-col overflow-hidden h-[600px]">
                    <div class="p-4 border-b bg-gray-50 flex justify-between items-center">
                        <h2 class="text-xl font-bold text-gray-700">Classifica</h2>
                        <button id="exportCsvBtn" title="Esporta CSV" class="text-gray-400 hover:text-green-600"><i data-lucide="file-down" class="w-5 h-5"></i></button>
                    </div>
                    <div class="overflow-auto flex-grow">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-100 text-gray-600 uppercase text-xs sticky top-0">
                                <tr>
                                    <th class="p-3 text-center w-12">#</th>
                                    <th class="p-3 text-left">Squadra</th>
                                    <th class="p-3 text-center">Check</th>
                                    <th class="p-3 text-right">Punti</th>
                                </tr>
                            </thead>
                            <tbody id="leaderboardBody">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="activityLogView" class="hidden">
             <div class="bg-white p-6 rounded-xl shadow-lg max-w-4xl mx-auto">
                <button id="backToDashboardFromLog" class="mb-6 text-brand-green font-bold flex items-center hover:underline">
                    <i data-lucide="arrow-left" class="w-5 h-5 mr-2"></i> Torna alla Dashboard
                </button>
                <h2 class="text-2xl font-black mb-6 text-center text-gray-800">Log Attività in Tempo Reale</h2>
                <div id="activityLogContainer" class="space-y-4 max-h-[70vh] overflow-y-auto pr-2">
                    </div>
            </div>
        </div>
        
        <div id="organizerTeamsView" class="hidden">
            <div class="bg-white p-6 rounded-xl shadow-lg max-w-2xl mx-auto">
                <button id="backToDashboardFromTeams" class="mb-6 text-brand-green font-bold flex items-center hover:underline">
                    <i data-lucide="arrow-left" class="w-5 h-5 mr-2"></i> Torna alla Dashboard
                </button>
                <h2 class="text-2xl font-bold mb-4 text-gray-800">Squadre Iscritte</h2>
                <div id="teamsList" class="space-y-3">
                    </div>
            </div>
        </div>

        <div id="organizerAdminView" class="hidden">
            <div class="bg-white p-6 rounded-xl shadow-lg max-w-6xl mx-auto h-[85vh] flex flex-col">
                <button id="backToDashboardBtn" class="mb-4 text-brand-green font-bold flex items-center hover:underline flex-shrink-0">
                    <i data-lucide="arrow-left" class="w-5 h-5 mr-2"></i> Torna alla Dashboard
                </button>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 flex-grow overflow-hidden">
                    <div class="overflow-y-auto pr-2">
                        <h2 class="text-2xl font-bold mb-6 text-brand-green">Editor Punto di Controllo</h2>
                        <form id="addCheckpointForm" class="space-y-5 bg-gray-50 p-6 rounded-lg border border-gray-200">
                            <input type="hidden" id="editCheckpointId">
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="cp-number" class="block text-sm font-bold mb-1">Numero (#)</label>
                                    <input type="number" id="cp-number" name="number" required class="w-full p-2 border rounded-md text-center font-bold text-lg">
                                </div>
                                <div>
                                    <label for="cp-points" class="block text-sm font-bold mb-1">Punti Base</label>
                                    <input type="number" id="cp-points" name="points" required class="w-full p-2 border rounded-md text-center">
                                </div>
                            </div>

                            <div>
                                <label for="cp-question" class="block text-sm font-bold mb-1">Domanda / Indizio</label>
                                <textarea id="cp-question" name="question" required rows="3" class="w-full p-2 border rounded-md"></textarea>
                            </div>

                            <div>
                                <label for="cp-description" class="block text-sm font-bold mb-1">Descrizione / Storia (Facoltativo)</label>
                                <textarea id="cp-description" name="description" rows="3" class="w-full p-2 border rounded-md text-sm text-gray-600" placeholder="Es. Cenni storici sul monumento, testo da leggere..."></textarea>
                            </div>

                            <div>
                                <label for="cp-placeholder" class="block text-sm font-bold mb-1">Esempio Risposta (Placeholder)</label>
                                <input type="text" id="cp-placeholder" name="placeholder" class="w-full p-2 border rounded-md text-sm text-gray-500 italic" placeholder="Es. 1860 (compare dentro la casella di risposta)">
                            </div>

                            <div>
                                <label for="cp-correctAnswer" class="block text-sm font-bold mb-1">Risposta Esatta</label>
                                <input type="text" id="cp-correctAnswer" name="correctAnswer" required class="w-full p-2 border rounded-md bg-green-50 border-green-200">
                            </div>
                            
                            <div>
                                <label for="cp-image" class="block text-sm font-bold mb-1">Immagine (Opzionale)</label>
                                <input type="file" id="cp-image" name="image" accept="image/*" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-brand-green file:text-white hover:file:bg-green-700">
                            </div>
                            
                            <div class="flex flex-col gap-2 pt-2">
                                <button type="submit" class="w-full p-3 rounded-md font-bold transition-colors btn btn-secondary shadow-md">Aggiungi Punto</button>
                                <button type="button" id="cancelEditBtn" class="hidden w-full bg-gray-400 text-white p-2 rounded-md font-bold hover:bg-gray-500 text-sm">Annulla Modifica</button>
                            </div>
                        </form>
                    </div>
                    
                    <div class="flex flex-col overflow-hidden bg-gray-50 rounded-lg border border-gray-200">
                        <div class="p-4 border-b bg-white">
                            <h2 class="text-xl font-bold text-gray-700">Lista Punti</h2>
                        </div>
                        <div id="checkpointsList" class="flex-grow overflow-y-auto p-4 space-y-3">
                            </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="participantView" class="hidden">
            <header class="bg-white p-4 rounded-xl shadow-lg mb-6 flex justify-between items-center sticky top-0 z-20 border-b-4 border-brand-orange">
                <div>
                    <h1 class="text-xl md:text-2xl font-black text-brand-green">Mappa Gara</h1>
                    <p id="participant-team-name-display" class="text-sm font-bold text-gray-500"></p>
                </div>
                <button id="logout-participant" class="btn-icon bg-red-500 hover:bg-red-600"><i data-lucide="log-out" class="w-5 h-5"></i></button>
            </header>
            
             <div id="game-finished-banner" class="hidden bg-yellow-400 text-yellow-900 p-4 rounded-lg mb-6 text-center font-bold shadow-md animate-bounce">
                 ⚠️ GARA TERMINATA - MODALITÀ SOLA LETTURA
             </div>

             <div class="bg-blue-50 border-l-4 border-blue-500 text-blue-800 p-4 mb-6 rounded-r shadow-sm">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <i data-lucide="info" class="w-6 h-6 text-blue-600"></i>
                    </div>
                    <div class="ml-3">
                        <p class="font-bold text-sm uppercase">Attenzione alla Compilazione</p>
                        <p class="text-sm mt-1">
                            Scrivete le risposte con precisione. Osservate il <strong>testo di esempio (in grigio)</strong> che appare nella casella prima di scrivere: vi suggerisce il formato corretto (es. date, nomi, spazi).
                        </p>
                    </div>
                </div>
            </div>

            <div id="checkpointsGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 pb-10">
                </div>
        </div>
        
        <div id="checkpointView" class="hidden">
            <div class="bg-white p-6 rounded-xl shadow-2xl max-w-2xl mx-auto min-h-[80vh] flex flex-col">
                <button id="backToGrid" class="mb-6 text-brand-green font-bold flex items-center hover:underline self-start"> 
                    <i data-lucide="arrow-left" class="w-5 h-5 mr-2"></i> Torna alla Mappa 
                </button>
                
                <div class="flex-grow">
                    <div id="checkpointDetail" class="mb-8">
                        </div>
                    
                    <form id="submissionForm" class="space-y-6">
                        <input type="hidden" id="checkpointIdInput">
                        <input type="hidden" id="teamIdInput">
                        
                        <div>
                            <label for="answer" class="block text-lg font-bold mb-2 text-gray-800">La tua risposta:</label>
                            <input type="text" id="answer" name="answer" required class="w-full p-4 border-2 border-gray-300 rounded-lg text-lg focus:border-brand-orange" placeholder="Scrivi qui...">
                        </div>
                        
                        <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
                            <p class="block text-md font-bold mb-2 text-blue-800 flex items-center"><i data-lucide="camera" class="w-5 h-5 mr-2"></i> Scatta/Carica Foto:</p>
                            <input type="file" id="photo" name="photo" accept="image/*" required class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700 cursor-pointer">
                            <div id="photo-preview-container" class="mt-4"></div>
                        </div>
                        
                        <button type="submit" class="w-full p-4 rounded-lg text-xl font-black text-white shadow-lg transform hover:scale-105 transition-all flex items-center justify-center btn btn-primary">
                            INVIA RISPOSTA
                        </button>
                        
                        <button type="button" id="deleteSubmissionBtn" class="hidden w-full bg-white border-2 border-red-500 text-red-600 p-3 rounded-lg font-bold hover:bg-red-50 mt-4">
                            Cancella e Riprova
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <div id="organizerDetailView" class="hidden">
            <div class="bg-white p-8 rounded-xl shadow-2xl max-w-2xl mx-auto">
                <button id="backToOrganizer" class="mb-6 text-brand-green font-bold flex items-center hover:underline"> 
                    <i data-lucide="arrow-left" class="w-5 h-5 mr-2"></i> Torna alla Dashboard 
                </button>
                <h2 class="text-2xl font-black mb-6 border-b pb-2">Dettaglio Risposta</h2>
                <div id="organizerDetailContent" class="space-y-6 text-lg">
                    </div>
            </div>
        </div>

        <div id="modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full transform transition-all scale-100">
                <h3 id="modalTitle" class="text-xl font-black mb-4 text-gray-800"></h3>
                <p id="modalMessage" class="text-gray-600 mb-8 leading-relaxed"></p>
                <div class="flex justify-end space-x-3">
                    <button id="modalCancelBtn" class="px-5 py-2 bg-gray-200 text-gray-700 font-bold rounded-md hover:bg-gray-300 transition-colors">Annulla</button>
                    <button id="modalConfirmBtn" class="px-5 py-2 bg-brand-orange text-white font-bold rounded-md hover:bg-orange-600 shadow-md transition-colors">Conferma</button>
                </div>
            </div>
        </div>

        <div id="photoModal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-md flex items-center justify-center p-4 z-50" onclick="document.getElementById('photoModal').classList.add('hidden')">
            <div class="relative max-w-4xl w-full max-h-[90vh] flex items-center justify-center">
                <button id="closePhotoModalBtn" class="absolute -top-12 right-0 md:-right-12 text-white hover:text-gray-300">
                    <i data-lucide="x" class="w-10 h-10"></i>
                </button>
                <img id="modalImage" src="" alt="Foto zoom" class="max-w-full max-h-[85vh] object-contain rounded-lg shadow-2xl border border-white/20">
            </div>
        </div>

    </div>
</body>
</html>